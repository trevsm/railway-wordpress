#!/usr/bin/env bash
set -e

# Railway workaround: ensure only one MPM is enabled (prefork) right before Apache starts.
a2dismod mpm_event  2>/dev/null || true
a2dismod mpm_worker 2>/dev/null || true
a2dismod mpm_prefork 2>/dev/null || true
a2enmod  mpm_prefork 2>/dev/null || true

# Hard cleanup in case symlinks were recreated
rm -f /etc/apache2/mods-enabled/mpm_event.* /etc/apache2/mods-enabled/mpm_worker.*
ln -sf ../mods-available/mpm_prefork.load /etc/apache2/mods-enabled/mpm_prefork.load
ln -sf ../mods-available/mpm_prefork.conf /etc/apache2/mods-enabled/mpm_prefork.conf

exec /usr/local/bin/apache2-foreground.orig
